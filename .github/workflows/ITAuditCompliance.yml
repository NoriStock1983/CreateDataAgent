name: IT Audit Compliance Workflow
on:
  push:
    branches: [ main, develop, release ]
  pull_request:
    branches: [ main, develop, release ]

env:
  AUDIT_LOG_RETENTION: 2555 # 7å¹´é–“ä¿å­˜ (J-SOXè¦ä»¶)
  SECURITY_BASELINE_VERSION: "v1.0"

jobs:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç¢ºèª (ISO27001 A.12.6.1å¯¾å¿œ)
  security-baseline-check:
    runs-on: ubuntu-latest
    outputs:
      baseline-status: ${{ steps.baseline.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´å–å¾—ã§å¤‰æ›´è¿½è·¡
      
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          echo "AUDIT_START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          mkdir -p audit-logs
      
      - name: Security baseline verification
        id: baseline
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç¢ºèªé–‹å§‹ ===" | tee -a audit-logs/security-baseline.log
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a audit-logs/security-baseline.log
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}" | tee -a audit-logs/security-baseline.log
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" | tee -a audit-logs/security-baseline.log
          echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" | tee -a audit-logs/security-baseline.log
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯
          baseline_status="PASS"
          
          # 1. ãƒ–ãƒ©ãƒ³ãƒä¿è­·è¨­å®šç¢ºèª
          echo "1. ãƒ–ãƒ©ãƒ³ãƒä¿è­·è¨­å®šç¢ºèª" | tee -a audit-logs/security-baseline.log
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "  - ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æŽ¥ãƒ—ãƒƒã‚·ãƒ¥æ¤œå‡º" | tee -a audit-logs/security-baseline.log
            baseline_status="FAIL"
          fi
          
          # 2. æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
          echo "2. æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³" | tee -a audit-logs/security-baseline.log
          secrets_found=0
          
          # APIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if grep -r -E "(api[_-]?key|password|secret|token)" --include="*.py" --include="*.js" --include="*.json" --include="*.yaml" --include="*.yml" . || true; then
            echo "  - æ½œåœ¨çš„ãªæ©Ÿå¯†æƒ…å ±ã‚’æ¤œå‡º" | tee -a audit-logs/security-baseline.log
            secrets_found=1
          fi
          
          # AWS ã‚­ãƒ¼
          if grep -r -E "AKIA[0-9A-Z]{16}" . || true; then
            echo "  - AWS ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’æ¤œå‡º" | tee -a audit-logs/security-baseline.log
            secrets_found=1
          fi
          
          # GitHub ãƒˆãƒ¼ã‚¯ãƒ³
          if grep -r -E "ghp_[a-zA-Z0-9]{36}" . || true; then
            echo "  - GitHub ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œå‡º" | tee -a audit-logs/security-baseline.log
            secrets_found=1
          fi
          
          if [ $secrets_found -eq 1 ]; then
            baseline_status="FAIL"
          fi
          
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³çµæžœ: $baseline_status" | tee -a audit-logs/security-baseline.log
          echo "status=$baseline_status" >> $GITHUB_OUTPUT
      
      - name: Upload security baseline logs
        uses: actions/upload-artifact@v4
        with:
          name: security-baseline-logs-${{ env.AUDIT_SESSION_ID }}
          path: audit-logs/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}

  # è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (ISO27001 A.12.6.1å¯¾å¿œ)
  vulnerability-scan:
    runs-on: ubuntu-latest
    needs: security-baseline-check
    outputs:
      vuln-status: ${{ steps.vuln-scan.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          mkdir -p audit-logs
      
      - name: Dependency vulnerability scan
        id: vuln-scan
        run: |
          echo "=== è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ===" | tee -a audit-logs/vulnerability-scan.log
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a audit-logs/vulnerability-scan.log
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}" | tee -a audit-logs/vulnerability-scan.log
          
          vuln_status="PASS"
          
          # package.jsonãŒå­˜åœ¨ã™ã‚‹å ´åˆã®npm audit
          if [ -f "package.json" ]; then
            echo "Node.js ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..." | tee -a audit-logs/vulnerability-scan.log
            npm install --package-lock-only
            if ! npm audit --audit-level=moderate; then
              echo "é‡å¤§ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" | tee -a audit-logs/vulnerability-scan.log
              npm audit --json > audit-logs/npm-audit-results.json
              vuln_status="FAIL"
            fi
          fi
          
          # requirements.txtãŒå­˜åœ¨ã™ã‚‹å ´åˆã®Pythonä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
          if [ -f "requirements.txt" ]; then
            echo "Python ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..." | tee -a audit-logs/vulnerability-scan.log
            pip install safety
            if ! safety check -r requirements.txt; then
              echo "Pythonä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" | tee -a audit-logs/vulnerability-scan.log
              vuln_status="FAIL"
            fi
          fi
          
          echo "è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæžœ: $vuln_status" | tee -a audit-logs/vulnerability-scan.log
          echo "status=$vuln_status" >> $GITHUB_OUTPUT
      
      - name: Upload vulnerability scan logs
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-logs-${{ env.AUDIT_SESSION_ID }}
          path: audit-logs/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}

  # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ (SAST)
  code-security-scan:
    runs-on: ubuntu-latest
    needs: security-baseline-check
    outputs:
      code-status: ${{ steps.code-scan.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          mkdir -p audit-logs
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        id: code-scan
        uses: github/codeql-action/analyze@v3
        with:
          output: audit-logs/codeql-results
      
      - name: Process CodeQL results
        run: |
          echo "=== ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ===" | tee -a audit-logs/code-scan.log
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a audit-logs/code-scan.log
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}" | tee -a audit-logs/code-scan.log
          
          code_status="PASS"
          
          # CodeQLçµæžœãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "audit-logs/codeql-results" ]; then
            result_count=$(find audit-logs/codeql-results -name "*.sarif" -exec jq '.runs[].results | length' {} \; | awk '{sum+=$1} END {print sum}')
            if [ "$result_count" -gt 0 ]; then
              echo "ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $result_count ä»¶" | tee -a audit-logs/code-scan.log
              code_status="WARNING"
            fi
          fi
          
          echo "ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³çµæžœ: $code_status" | tee -a audit-logs/code-scan.log
          echo "status=$code_status" >> $GITHUB_OUTPUT
      
      - name: Upload code scan logs
        uses: actions/upload-artifact@v4
        with:
          name: code-scan-logs-${{ env.AUDIT_SESSION_ID }}
          path: audit-logs/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}

  # å¤‰æ›´ç®¡ç†è¨˜éŒ² (J-SOXå¯¾å¿œ)
  change-management:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    outputs:
      change-status: ${{ steps.change-log.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          mkdir -p audit-logs
      
      - name: Record change management
        id: change-log
        run: |
          echo "=== å¤‰æ›´ç®¡ç†è¨˜éŒ²é–‹å§‹ ===" | tee -a audit-logs/change-management.log
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a audit-logs/change-management.log
          echo "å¤‰æ›´è€…: ${{ github.actor }}" | tee -a audit-logs/change-management.log
          echo "å¤‰æ›´ã‚¿ã‚¤ãƒ—: ${{ github.event_name }}" | tee -a audit-logs/change-management.log
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" | tee -a audit-logs/change-management.log
          echo "ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: ${{ github.sha }}" | tee -a audit-logs/change-management.log
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" | tee -a audit-logs/change-management.log
          
          change_status="RECORDED"
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜éŒ²
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:" | tee -a audit-logs/change-management.log
          if [ "${{ github.event_name }}" = "push" ]; then
            git diff --name-only ${{ github.event.before }}..${{ github.sha }} | tee -a audit-logs/change-management.log
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.sha }} | tee -a audit-logs/change-management.log
          fi
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨˜éŒ²
          echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:" | tee -a audit-logs/change-management.log
          git log --oneline -1 ${{ github.sha }} | tee -a audit-logs/change-management.log
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ‰¿èªæƒ…å ±è¨˜éŒ²
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç•ªå·: ${{ github.event.pull_request.number }}" | tee -a audit-logs/change-management.log
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.pull_request.title }}" | tee -a audit-logs/change-management.log
            echo "ä½œæˆè€…: ${{ github.event.pull_request.user.login }}" | tee -a audit-logs/change-management.log
          fi
          
          echo "å¤‰æ›´ç®¡ç†è¨˜éŒ²çµæžœ: $change_status" | tee -a audit-logs/change-management.log
          echo "status=$change_status" >> $GITHUB_OUTPUT
      
      - name: Upload change management logs
        uses: actions/upload-artifact@v4
        with:
          name: change-management-logs-${{ env.AUDIT_SESSION_ID }}
          path: audit-logs/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}

  # ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç›£æŸ» (ISO27001 A.9å¯¾å¿œ)
  access-control-audit:
    runs-on: ubuntu-latest
    outputs:
      access-status: ${{ steps.access-audit.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          mkdir -p audit-logs
      
      - name: Access control audit
        id: access-audit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç›£æŸ»é–‹å§‹ ===" | tee -a audit-logs/access-control.log
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date -u +%Y-%m-%dT%H:%M:%SZ)" | tee -a audit-logs/access-control.log
          echo "ç›£æŸ»å®Ÿè¡Œè€…: ${{ github.actor }}" | tee -a audit-logs/access-control.log
          
          access_status="PASS"
          
          # ãƒªãƒã‚¸ãƒˆãƒªã®æ¨©é™è¨­å®šç¢ºèª
          echo "ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª:" | tee -a audit-logs/access-control.log
          
          # GitHub API ã§ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±å–å¾—
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
             "https://api.github.com/repos/${{ github.repository }}/collaborators" > collaborators.json; then
            
            echo "ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸€è¦§:" | tee -a audit-logs/access-control.log
            jq -r '.[] | "- \(.login): \(.permissions.admin // false | if . then "admin" else (.permissions.push // false | if . then "write" else "read" end) end)"' collaborators.json | tee -a audit-logs/access-control.log
            
            # ç®¡ç†è€…æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
            admin_count=$(jq '[.[] | select(.permissions.admin == true)] | length' collaborators.json)
            echo "ç®¡ç†è€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: $admin_count" | tee -a audit-logs/access-control.log
            
            if [ "$admin_count" -gt 3 ]; then
              echo "è­¦å‘Š: ç®¡ç†è€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤šã™ãŽã¾ã™" | tee -a audit-logs/access-control.log
              access_status="WARNING"
            fi
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã®ç¢ºèª
          echo "ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ç¢ºèª:" | tee -a audit-logs/access-control.log
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
             "https://api.github.com/repos/${{ github.repository }}/branches/main/protection" > branch_protection.json; then
            
            if jq -e '.required_status_checks' branch_protection.json > /dev/null; then
              echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯: æœ‰åŠ¹" | tee -a audit-logs/access-control.log
            else
              echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯: ç„¡åŠ¹" | tee -a audit-logs/access-control.log
              access_status="WARNING"
            fi
            
            if jq -e '.required_pull_request_reviews' branch_protection.json > /dev/null; then
              echo "- ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼: æœ‰åŠ¹" | tee -a audit-logs/access-control.log
            else
              echo "- ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼: ç„¡åŠ¹" | tee -a audit-logs/access-control.log
              access_status="WARNING"
            fi
          fi
          
          echo "ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç›£æŸ»çµæžœ: $access_status" | tee -a audit-logs/access-control.log
          echo "status=$access_status" >> $GITHUB_OUTPUT
      
      - name: Upload access control logs
        uses: actions/upload-artifact@v4
        with:
          name: access-control-logs-${{ env.AUDIT_SESSION_ID }}
          path: audit-logs/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}

  # ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  generate-audit-report:
    runs-on: ubuntu-latest
    needs: [security-baseline-check, vulnerability-scan, code-security-scan, change-management, access-control-audit]
    if: always()
    steps:
      - name: Setup audit logging
        run: |
          echo "AUDIT_SESSION_ID=$(date +%Y%m%d-%H%M%S)-$(uuidgen | cut -d'-' -f1)" >> $GITHUB_ENV
          mkdir -p audit-reports
      
      - name: Download all audit artifacts
        uses: actions/download-artifact@v4
        with:
          path: audit-artifacts/
      
      - name: Generate comprehensive audit report
        run: |
          echo "# ITç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ" > audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          echo "**ç”Ÿæˆæ—¥æ™‚**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> audit-reports/audit-report.md
          echo "**å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}" >> audit-reports/audit-report.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> audit-reports/audit-report.md
          echo "**å®Ÿè¡Œè€…**: ${{ github.actor }}" >> audit-reports/audit-report.md
          echo "**ç›£æŸ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ID**: $AUDIT_SESSION_ID" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          
          echo "## ç›£æŸ»çµæžœã‚µãƒžãƒªãƒ¼" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          
          # å„ãƒã‚§ãƒƒã‚¯ã®çµæžœã‚’é›†è¨ˆ
          echo "| ç›£æŸ»é …ç›® | çµæžœ | æº–æ‹ è¦æ ¼ |" >> audit-reports/audit-report.md
          echo "|----------|------|----------|" >> audit-reports/audit-report.md
          echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | ${{ needs.security-baseline-check.outputs.baseline-status || 'N/A' }} | ISO27001 A.12.6.1 |" >> audit-reports/audit-report.md
          echo "| è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.vulnerability-scan.outputs.vuln-status || 'N/A' }} | ISO27001 A.12.6.1 |" >> audit-reports/audit-report.md
          echo "| ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.code-security-scan.outputs.code-status || 'N/A' }} | ISO27001 A.14.2.1 |" >> audit-reports/audit-report.md
          echo "| å¤‰æ›´ç®¡ç† | ${{ needs.change-management.outputs.change-status || 'N/A' }} | J-SOX |" >> audit-reports/audit-report.md
          echo "| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | ${{ needs.access-control-audit.outputs.access-status || 'N/A' }} | ISO27001 A.9 |" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          
          # ç·åˆåˆ¤å®š
          overall_status="PASS"
          if [[ "${{ needs.security-baseline-check.outputs.baseline-status }}" == "FAIL" ]] || \
             [[ "${{ needs.vulnerability-scan.outputs.vuln-status }}" == "FAIL" ]]; then
            overall_status="FAIL"
          elif [[ "${{ needs.code-security-scan.outputs.code-status }}" == "WARNING" ]] || \
               [[ "${{ needs.access-control-audit.outputs.access-status }}" == "WARNING" ]]; then
            overall_status="WARNING"
          fi
          
          echo "## ç·åˆåˆ¤å®š: **$overall_status**" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          
          echo "## è©³ç´°ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          echo "ä»¥ä¸‹ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«å„ç›£æŸ»é …ç›®ã®è©³ç´°ãƒ­ã‚°ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼š" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¸€è¦§
          if [ -d "audit-artifacts" ]; then
            ls -la audit-artifacts/ | grep "^d" | awk '{print "- " $9}' >> audit-reports/audit-report.md
          fi
          
          echo "" >> audit-reports/audit-report.md
          echo "## æ³•çš„è¦ä»¶å¯¾å¿œçŠ¶æ³" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          echo "### ISO27001å¯¾å¿œ" >> audit-reports/audit-report.md
          echo "- A.9 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡: âœ“ å®Ÿæ–½æ¸ˆã¿" >> audit-reports/audit-report.md
          echo "- A.12.6.1 è„†å¼±æ€§ç®¡ç†: âœ“ å®Ÿæ–½æ¸ˆã¿" >> audit-reports/audit-report.md
          echo "- A.14.2.1 ã‚»ã‚­ãƒ¥ã‚¢ãªé–‹ç™º: âœ“ å®Ÿæ–½æ¸ˆã¿" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          echo "### J-SOXå¯¾å¿œ" >> audit-reports/audit-report.md
          echo "- å¤‰æ›´ç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹: âœ“ å®Ÿæ–½æ¸ˆã¿" >> audit-reports/audit-report.md
          echo "- ç›£æŸ»è¨¼è·¡ä¿å…¨: âœ“ å®Ÿæ–½æ¸ˆã¿ (${AUDIT_LOG_RETENTION}æ—¥é–“ä¿å­˜)" >> audit-reports/audit-report.log
          echo "" >> audit-reports/audit-report.md
          
          # æŽ¨å¥¨äº‹é …
          echo "## æŽ¨å¥¨äº‹é …" >> audit-reports/audit-report.md
          echo "" >> audit-reports/audit-report.md
          if [[ "$overall_status" == "FAIL" ]]; then
            echo "- é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚é€Ÿã‚„ã‹ã«å¯¾å‡¦ã—ã¦ãã ã•ã„ã€‚" >> audit-reports/audit-report.md
          elif [[ "$overall_status" == "WARNING" ]]; then
            echo "- ä¸€éƒ¨æ”¹å–„ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚æ¬¡å›žãƒªãƒªãƒ¼ã‚¹å‰ã«å¯¾å‡¦ã‚’æ¤œè¨Žã—ã¦ãã ã•ã„ã€‚" >> audit-reports/audit-report.md
          else
            echo "- ç¾åœ¨ã®ã¨ã“ã‚ã€é‡å¤§ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å®šæœŸçš„ãªç›£æŸ»ã®ç¶™ç¶šã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚" >> audit-reports/audit-report.md
          fi
          
          # JSONå½¢å¼ã®ã‚µãƒžãƒªãƒ¼ã‚‚ç”Ÿæˆ
          cat > audit-reports/audit-summary.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "session_id": "$AUDIT_SESSION_ID",
            "overall_status": "$overall_status",
            "results": {
              "security_baseline": "${{ needs.security-baseline-check.outputs.baseline-status || 'N/A' }}",
              "vulnerability_scan": "${{ needs.vulnerability-scan.outputs.vuln-status || 'N/A' }}",
              "code_security": "${{ needs.code-security-scan.outputs.code-status || 'N/A' }}",
              "change_management": "${{ needs.change-management.outputs.change-status || 'N/A' }}",
              "access_control": "${{ needs.access-control-audit.outputs.access-status || 'N/A' }}"
            },
            "compliance": {
              "iso27001": true,
              "j_sox": true
            }
          }
          EOF
      
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: audit-report-${{ env.AUDIT_SESSION_ID }}
          path: audit-reports/
          retention-days: ${{ env.AUDIT_LOG_RETENTION }}
      
      - name: Post audit summary as comment (for PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = fs.readFileSync('audit-reports/audit-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: auditReport
            });

  # ç›£æŸ»å¤±æ•—æ™‚ã®é€šçŸ¥
  audit-failure-notification:
    runs-on: ubuntu-latest
    needs: [security-baseline-check, vulnerability-scan]
    if: failure() || (needs.security-baseline-check.outputs.baseline-status == 'FAIL') || (needs.vulnerability-scan.outputs.vuln-status == 'FAIL')
    steps:
      - name: Send audit failure notification
        run: |
          echo "ðŸš¨ ITç›£æŸ»ã§é‡å¤§ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "è©³ç´°ã¯ Actions ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          
          # Slacké€šçŸ¥ã®ä¾‹ï¼ˆSLACK_WEBHOOK_URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸš¨ ITç›£æŸ»å¤±æ•—: ${{ github.repository }} - è©³ç´°ç¢ºèªãŒå¿…è¦ã§ã™\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
